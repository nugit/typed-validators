'use strict'

Object.defineProperty(exports, '__esModule', {
  value: true,
})
exports.default = stringifyValue

var _keyToString = require('./keyToString')

function stringifyValue(value, options = {}) {
  const {
    indent = '',
    limit = Infinity,
    enclosing = new WeakMap(),
    refCounter = [0],
    reachedLimit = [false],
  } = options

  if (value === null) {
    return 'null'
  }

  switch (typeof value) {
    case 'string': {
      const result = JSON.stringify(value)

      if (result.length > limit) {
        const truncTo =
          limit - ` ... ${result.length - limit} more characters"`.length - 1
        const numElided = result.length - truncTo
        return (
          result.substring(0, truncTo) +
          ` ... ${numElided} more character${numElided === 1 ? '' : 's'}"`
        )
      }

      return result
    }

    case 'number':
      return Object.is(value, -0) ? '-0' : String(value)

    case 'symbol':
    case 'boolean':
    case 'undefined':
      return String(value)

    case 'function':
      return `[function ${value.name}]`
  }

  if (enclosing.has(value)) {
    let refNumber = enclosing.get(value)

    if (refNumber == null) {
      refNumber = ++refCounter[0]
      enclosing.set(value, refNumber)
    }

    return `<ref *${refNumber}>`
  }

  enclosing.set(value, null)

  try {
    const nextIndent = indent + '  '
    const recurseOptions = {
      indent: nextIndent,
      limit,
      enclosing,
      reachedLimit,
      refCounter,
    }

    if (Array.isArray(value)) {
      // ARRAY
      if (!value.length) return `[]`
      let remaining =
        limit -
        `[\n${nextIndent}... ${value.length} more elements\n${indent}]`.length
      const lines = ['[']

      for (let i = 0; i < value.length; i++) {
        const elem = value[i]
        recurseOptions.limit = remaining - (nextIndent.length + 1)
        const stringified =
          nextIndent + stringifyValue(elem, recurseOptions) + ','
        remaining -= stringified.length + 1

        if (remaining < 0 || reachedLimit[0]) {
          const numElided = value.length - i
          lines.push(
            `${nextIndent}... ${numElided} more element${
              numElided === 1 ? '' : 's'
            }`
          )
          break
        }

        lines.push(stringified)
      }

      lines.push(indent + ']')
      const refNumber = enclosing.get(value)
      if (refNumber != null) lines[0] = `<ref *${refNumber}> ${lines[0]}`
      return lines.join('\n')
    } else {
      // OBJECT
      const { constructor } = value
      const opener =
        constructor != null && constructor !== Object
          ? `${constructor.name} {`
          : '{'
      const keys = [
        ...Object.keys(value),
        ...Object.getOwnPropertySymbols(value),
      ]
      let remaining =
        limit -
        `${opener}\n${nextIndent}... ${keys.length} more properties\n${indent}}`
          .length
      const lines = [opener]

      for (let i = 0; i < keys.length; i++) {
        const key = keys[i]
        const propValue = value[key]
        const stringifiedKey = (0, _keyToString.keyToString)(key)
        recurseOptions.limit =
          remaining - (stringifiedKey.length + 3 + nextIndent.length)
        const stringifiedValue = stringifyValue(propValue, recurseOptions)
        const final = `${nextIndent}${stringifiedKey}: ${stringifiedValue},`
        remaining -= final.length + 1

        if (remaining < 0 || reachedLimit[0]) {
          const numElided = keys.length - i
          lines.push(
            `${nextIndent}... ${numElided} more propert${
              numElided === 1 ? 'y' : 'ies'
            }`
          )
          break
        }

        lines.push(final)
      }

      if (lines.length === 1) return opener + '}'
      lines.push(indent + '}')
      const refNumber = enclosing.get(value)
      if (refNumber != null) lines[0] = `<ref *${refNumber}> ${lines[0]}`
      return lines.join('\n')
    }
  } finally {
    enclosing.delete(value)
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lcnJvclJlcG9ydGluZy9zdHJpbmdpZnlWYWx1ZS50cyJdLCJuYW1lcyI6WyJzdHJpbmdpZnlWYWx1ZSIsInZhbHVlIiwib3B0aW9ucyIsImluZGVudCIsImxpbWl0IiwiSW5maW5pdHkiLCJlbmNsb3NpbmciLCJXZWFrTWFwIiwicmVmQ291bnRlciIsInJlYWNoZWRMaW1pdCIsInJlc3VsdCIsIkpTT04iLCJzdHJpbmdpZnkiLCJsZW5ndGgiLCJ0cnVuY1RvIiwibnVtRWxpZGVkIiwic3Vic3RyaW5nIiwiT2JqZWN0IiwiaXMiLCJTdHJpbmciLCJuYW1lIiwiaGFzIiwicmVmTnVtYmVyIiwiZ2V0Iiwic2V0IiwibmV4dEluZGVudCIsInJlY3Vyc2VPcHRpb25zIiwiQXJyYXkiLCJpc0FycmF5IiwicmVtYWluaW5nIiwibGluZXMiLCJpIiwiZWxlbSIsInN0cmluZ2lmaWVkIiwicHVzaCIsImpvaW4iLCJjb25zdHJ1Y3RvciIsIm9wZW5lciIsImtleXMiLCJnZXRPd25Qcm9wZXJ0eVN5bWJvbHMiLCJrZXkiLCJwcm9wVmFsdWUiLCJzdHJpbmdpZmllZEtleSIsInN0cmluZ2lmaWVkVmFsdWUiLCJmaW5hbCIsImRlbGV0ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQVVlLFNBQVNBLGNBQVQsQ0FDYkMsS0FEYSxFQUViQyxPQUFnQixHQUFHLEVBRk4sRUFHTDtBQUNSLFFBQU07QUFDSkMsSUFBQUEsTUFBTSxHQUFHLEVBREw7QUFFSkMsSUFBQUEsS0FBSyxHQUFHQyxRQUZKO0FBR0pDLElBQUFBLFNBQVMsR0FBRyxJQUFJQyxPQUFKLEVBSFI7QUFJSkMsSUFBQUEsVUFBVSxHQUFHLENBQUMsQ0FBRCxDQUpUO0FBS0pDLElBQUFBLFlBQVksR0FBRyxDQUFDLEtBQUQ7QUFMWCxNQU1GUCxPQU5KOztBQU9BLE1BQUlELEtBQUssS0FBSyxJQUFkLEVBQW9CO0FBQ2xCLFdBQU8sTUFBUDtBQUNEOztBQUNELFVBQVEsT0FBT0EsS0FBZjtB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QUFpQixDQUFyQixFQUF3QixPQUFPd0IsTUFBTSxHQUFHLEdBQWhCO0FBQ3hCUCxNQUFBQSxLQUFLLENBQUNJLElBQU4sQ0FBVy9CLE1BQU0sR0FBRyxHQUFwQjtBQUVBLFlBQU1tQixTQUFTLEdBQUdoQixTQUFTLENBQUNpQixHQUFWLENBQWN0QixLQUFkLENBQWxCO0FBQ0EsVUFBSXFCLFNBQVMsSUFBSSxJQUFqQixFQUF1QlEsS0FBSyxDQUFDLENBQUQsQ0FBTCxHQUFZLFNBQVFSLFNBQVUsS0FBSVEsS0FBSyxDQUFDLENBQUQsQ0FBSSxFQUEzQztBQUV2QixhQUFPQSxLQUFLLENBQUNLLElBQU4sQ0FBVyxJQUFYLENBQVA7QUFDRDtBQUNGLEdBakZELFNBaUZVO0FBQ1I3QixJQUFBQSxTQUFTLENBQUN1QyxNQUFWLENBQWlCNUMsS0FBakI7QUFDRDtBQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsga2V5VG9TdHJpbmcgfSBmcm9tICcuL2tleVRvU3RyaW5nJ1xuXG50eXBlIE9wdGlvbnMgPSB7XG4gIGluZGVudD86IHN0cmluZ1xuICBsaW1pdD86IG51bWJlclxuICBlbmNsb3Npbmc/OiBXZWFrTWFwPGFueSwgbnVtYmVyIHwgbnVsbD5cbiAgcmVmQ291bnRlcj86IFtudW1iZXJdXG4gIHJlYWNoZWRMaW1pdD86IFtib29sZWFuXVxufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBzdHJpbmdpZnlWYWx1ZShcbiAgdmFsdWU6IGFueSxcbiAgb3B0aW9uczogT3B0aW9ucyA9IHt9XG4pOiBzdHJpbmcge1xuICBjb25zdCB7XG4gICAgaW5kZW50ID0gJycsXG4gICAgbGltaXQgPSBJbmZpbml0eSxcbiAgICBlbmNsb3NpbmcgPSBuZXcgV2Vha01hcCgpLFxuICAgIHJlZkNvdW50ZXIgPSBbMF0gYXMgW251bWJlcl0sXG4gICAgcmVhY2hlZExpbWl0ID0gW2ZhbHNlXSBhcyBbYm9vbGVhbl0sXG4gIH0gPSBvcHRpb25zXG4gIGlmICh2YWx1ZSA9PT0gbnVsbCkge1xuICAgIHJldHVybiAnbnVsbCdcbiAgfVxuICBzd2l0Y2ggKHR5cGVvZiB2YWx1ZSkge1xuICAgIGNhc2UgJ3N0cmluZyc6IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IEpTT04uc3RyaW5naWZ5KHZhbHVlKVxuICAgICAgaWYgKHJlc3VsdC5sZW5ndGggPiBsaW1pdCkge1xuICAgICAgICBjb25zdCB0cnVuY1RvID1cbiAgICAgICAgICBsaW1pdCAtIGAgLi4uICR7cmVzdWx0Lmxlbmd0aCAtIGxpbWl0fSBtb3JlIGNoYXJhY3RlcnNcImAubGVuZ3RoIC0gMVxuICAgICAgICBjb25zdCBudW1FbGlkZWQgPSByZXN1bHQubGVuZ3RoIC0gdHJ1bmNUb1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgIHJlc3VsdC5zdWJzdHJpbmcoMCwgdHJ1bmNUbykgK1xuICAgICAgICAgIGAgLi4uICR7bnVtRWxpZGVkfSBtb3JlIGNoYXJhY3RlciR7bnVtRWxpZGVkID09PSAxID8gJycgOiAncyd9XCJgXG4gICAgICAgIClcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXN1bHRcbiAgICB9XG4gICAgY2FzZSAnbnVtYmVyJzpcbiAgICAgIHJldHVybiBPYmplY3QuaXModmFsdWUsIC0wKSA/ICctMCcgOiBTdHJpbmcodmFsdWUpXG4gICAgY2FzZSAnc3ltYm9sJzpcbiAgICBjYXNlICdib29sZWFuJzpcbiAgICBjYXNlICd1bmRlZmluZWQnOlxuICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSlcbiAgICBjYXNlICdmdW5jdGlvbic6XG4gICAgICByZXR1cm4gYFtmdW5jdGlvbiAke3ZhbHVlLm5hbWV9XWBcbiAgfVxuICBpZiAoZW5jbG9zaW5nLmhhcyh2YWx1ZSkpIHtcbiAgICBsZXQgcmVmTnVtYmVyID0gZW5jbG9zaW5nLmdldCh2YWx1ZSlcbiAgICBpZiAocmVmTnVtYmVyID09IG51bGwpIHtcbiAgICAgIHJlZk51bWJlciA9ICsrcmVmQ291bnRlclswXVxuICAgICAgZW5jbG9zaW5nLnNldCh2YWx1ZSwgcmVmTnVtYmVyKVxuICAgIH1cbiAgICByZXR1cm4gYDxyZWYgKiR7cmVmTnVtYmVyfT5gXG4gIH1cbiAgZW5jbG9zaW5nLnNldCh2YWx1ZSwgbnVsbClcbiAgdHJ5IHtcbiAgICBjb25zdCBuZXh0SW5kZW50ID0gaW5kZW50ICsgJyAgJ1xuICAgIGNvbnN0IHJlY3Vyc2VPcHRpb25zOiBPcHRpb25zID0ge1xuICAgICAgaW5kZW50OiBuZXh0SW5kZW50LFxuICAgICAgbGltaXQsXG4gICAgICBlbmNsb3NpbmcsXG4gICAgICByZWFjaGVkTGltaXQsXG4gICAgICByZWZDb3VudGVyLFxuICAgIH1cbiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgIC8vIEFSUkFZXG4gICAgICBpZiAoIXZhbHVlLmxlbmd0aCkgcmV0dXJuIGBbXWBcbiAgICAgIGxldCByZW1haW5pbmcgPVxuICAgICAgICBsaW1pdCAtXG4gICAgICAgIGBbXFxuJHtuZXh0SW5kZW50fS4uLiAke3ZhbHVlLmxlbmd0aH0gbW9yZSBlbGVtZW50c1xcbiR7aW5kZW50fV1gLmxlbmd0aFxuICAgICAgY29uc3QgbGluZXMgPSBbJ1snXVxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2YWx1ZS5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBlbGVtID0gdmFsdWVbaV1cbiAgICAgICAgcmVjdXJzZU9wdGlvbnMubGltaXQgPSByZW1haW5pbmcgLSAobmV4dEluZGVudC5sZW5ndGggKyAxKVxuICAgICAgICBjb25zdCBzdHJpbmdpZmllZCA9XG4gICAgICAgICAgbmV4dEluZGVudCArIHN0cmluZ2lmeVZhbHVlKGVsZW0sIHJlY3Vyc2VPcHRpb25zKSArICcsJ1xuICAgICAgICByZW1haW5pbmcgLT0gc3RyaW5naWZpZWQubGVuZ3RoICsgMVxuICAgICAgICBpZiAocmVtYWluaW5nIDwgMCB8fCByZWFjaGVkTGltaXRbMF0pIHtcbiAgICAgICAgICBjb25zdCBudW1FbGlkZWQgPSB2YWx1ZS5sZW5ndGggLSBpXG4gICAgICAgICAgbGluZXMucHVzaChcbiAgICAgICAgICAgIGAke25leHRJbmRlbnR9Li4uICR7bnVtRWxpZGVkfSBtb3JlIGVsZW1lbnQke1xuICAgICAgICAgICAgICBudW1FbGlkZWQgPT09IDEgPyAnJyA6ICdzJ1xuICAgICAgICAgICAgfWBcbiAgICAgICAgICApXG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgfVxuICAgICAgICBsaW5lcy5wdXNoKHN0cmluZ2lmaWVkKVxuICAgICAgfVxuICAgICAgbGluZXMucHVzaChpbmRlbnQgKyAnXScpXG4gICAgICBjb25zdCByZWZOdW1iZXIgPSBlbmNsb3NpbmcuZ2V0KHZhbHVlKVxuICAgICAgaWYgKHJlZk51bWJlciAhPSBudWxsKSBsaW5lc1swXSA9IGA8cmVmICoke3JlZk51bWJlcn0+ICR7bGluZXNbMF19YFxuICAgICAgcmV0dXJuIGxpbmVzLmpvaW4oJ1xcbicpXG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIE9CSkVDVFxuICAgICAgY29uc3QgeyBjb25zdHJ1Y3RvciB9ID0gdmFsdWVcbiAgICAgIGNvbnN0IG9wZW5lciA9XG4gICAgICAgIGNvbnN0cnVjdG9yICE9IG51bGwgJiYgY29uc3RydWN0b3IgIT09IE9iamVjdFxuICAgICAgICAgID8gYCR7Y29uc3RydWN0b3IubmFtZX0ge2BcbiAgICAgICAgICA6ICd7J1xuICAgICAgY29uc3Qga2V5cyA9IFtcbiAgICAgICAgLi4uT2JqZWN0LmtleXModmFsdWUpLFxuICAgICAgICAuLi5PYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKHZhbHVlKSxcbiAgICAgIF1cbiAgICAgIGxldCByZW1haW5pbmcgPVxuICAgICAgICBsaW1pdCAtXG4gICAgICAgIGAke29wZW5lcn1cXG4ke25leHRJbmRlbnR9Li4uICR7a2V5cy5sZW5ndGh9IG1vcmUgcHJvcGVydGllc1xcbiR7aW5kZW50fX1gXG4gICAgICAgICAgLmxlbmd0aFxuICAgICAgY29uc3QgbGluZXMgPSBbb3BlbmVyXVxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IGtleSA9IGtleXNbaV1cbiAgICAgICAgY29uc3QgcHJvcFZhbHVlID0gdmFsdWVba2V5XVxuICAgICAgICBjb25zdCBzdHJpbmdpZmllZEtleSA9IGtleVRvU3RyaW5nKGtleSlcbiAgICAgICAgcmVjdXJzZU9wdGlvbnMubGltaXQgPVxuICAgICAgICAgIHJlbWFpbmluZyAtIChzdHJpbmdpZmllZEtleS5sZW5ndGggKyAzICsgbmV4dEluZGVudC5sZW5ndGgpXG4gICAgICAgIGNvbnN0IHN0cmluZ2lmaWVkVmFsdWUgPSBzdHJpbmdpZnlWYWx1ZShwcm9wVmFsdWUsIHJlY3Vyc2VPcHRpb25zKVxuICAgICAgICBjb25zdCBmaW5hbCA9IGAke25leHRJbmRlbnR9JHtzdHJpbmdpZmllZEtleX06ICR7c3RyaW5naWZpZWRWYWx1ZX0sYFxuICAgICAgICByZW1haW5pbmcgLT0gZmluYWwubGVuZ3RoICsgMVxuICAgICAgICBpZiAocmVtYWluaW5nIDwgMCB8fCByZWFjaGVkTGltaXRbMF0pIHtcbiAgICAgICAgICBjb25zdCBudW1FbGlkZWQgPSBrZXlzLmxlbmd0aCAtIGlcbiAgICAgICAgICBsaW5lcy5wdXNoKFxuICAgICAgICAgICAgYCR7bmV4dEluZGVudH0uLi4gJHtudW1FbGlkZWR9IG1vcmUgcHJvcGVydCR7XG4gICAgICAgICAgICAgIG51bUVsaWRlZCA9PT0gMSA/ICd5JyA6ICdpZXMnXG4gICAgICAgICAgICB9YFxuICAgICAgICAgIClcbiAgICAgICAgICBicmVha1xuICAgICAgICB9XG4gICAgICAgIGxpbmVzLnB1c2goZmluYWwpXG4gICAgICB9XG4gICAgICBpZiAobGluZXMubGVuZ3RoID09PSAxKSByZXR1cm4gb3BlbmVyICsgJ30nXG4gICAgICBsaW5lcy5wdXNoKGluZGVudCArICd9JylcblxuICAgICAgY29uc3QgcmVmTnVtYmVyID0gZW5jbG9zaW5nLmdldCh2YWx1ZSlcbiAgICAgIGlmIChyZWZOdW1iZXIgIT0gbnVsbCkgbGluZXNbMF0gPSBgPHJlZiAqJHtyZWZOdW1iZXJ9PiAke2xpbmVzWzBdfWBcblxuICAgICAgcmV0dXJuIGxpbmVzLmpvaW4oJ1xcbicpXG4gICAgfVxuICB9IGZpbmFsbHkge1xuICAgIGVuY2xvc2luZy5kZWxldGUodmFsdWUpXG4gIH1cbn1cbiJdfQ==
